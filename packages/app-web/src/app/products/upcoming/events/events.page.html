@if (date && perimeter) {
  <app-upcoming-header
    #header
    [date]="date"
    [location]="location"
    [perimeter]="perimeter"
  ></app-upcoming-header>
}
<ion-content>
  <div class="events">
    @if (location) {
      <!--      <ion-toolbar style="&#45;&#45;background: transparent">-->
        <!--        <ion-buttons slot="start">-->
        <!--          <ion-button-->
        <!--            [title]="'Veranstaltungen nahe ' + location?.displayName + ' am ' +-->
        <!--                    formatDate(date?.subtract(1, 'day'), 'DD.MM')"-->
        <!--            (click)="changeDate(-1)"-->
        <!--          >-->
        <!--            <ion-icon name="arrow-back-outline" slot="start"></ion-icon>-->
        <!--            vorheriger Tag-->
        <!--          </ion-button>-->
        <!--        </ion-buttons>-->
        <!--        <ion-buttons slot="end">-->
        <!--          <ion-button-->
        <!--            [title]="'Veranstaltungen nahe ' + location?.displayName + ' am ' +-->
        <!--                    formatDate(date?.add(1, 'day'), 'DD.MM')"-->
        <!--            (click)="changeDate(+1)"-->
        <!--          >-->
        <!--            <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>-->
        <!--            nÃ¤chster Tag-->
        <!--          </ion-button>-->
        <!--        </ion-buttons>-->
        <!--      </ion-toolbar>-->

      <div class="ion-margin-bottom" style="min-height: 50vh">
        @if (date) {
          <div class="calendar ion-margin-top">
            <div class="calendar-row">
              <div
                style="font-size: 2rem; align-content: center"
                class="ion-hide-md-down"
              >
                <a
                  [routerLink]="getDateUrl(dateWindow[0].date.subtract(3, 'days'))"
                >
                  <ion-button
                    size="expand"
                    color="light"
                    (click)="$event.preventDefault(); $event.stopImmediatePropagation(); moveCalendarWindow(-3)"
                  >
                    <ion-icon name="arrow-back-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                </a>
              </div>
              <div class="calendar-days">
                @for (d of dateWindow; track d.date.toISOString(); let i = $index) {
                  <a
                    [routerLink]="'/'+createUrl(location, d.date)"
                    [ngClass]="{
                                'ion-hide-md-down': d.offset > 3
                              }"
                  >
                    <div
                      class="calendar-day"
                      (click)="$event.preventDefault(); $event.stopImmediatePropagation(); changeDate(d.date)"
                      [ngClass]="{
                                past: isPast(d.date),
                                active: isSame(date, d.date, ['day', 'month', 'year']),
                              }"
                    >
                      <div>{{ getWeekday(d.date) }}</div>
                      <h3 style="font-size: 1.5rem">{{ formatDate(d.date, "D") }}</h3>
                      @if (i == 0 || d.date.date() === 1) {
                        <div class="nowrap">{{ formatDate(d.date, "MMM YY") }}</div>
                      }
                    </div>
                  </a>
                }
              </div>
              <div style="font-size: 2rem; align-content: center">
                <a [routerLink]="getDateUrl(dateWindow[0].date.add(4, 'days'))">
                  <ion-button
                    size="expand"
                    color="light"
                    (click)="$event.preventDefault(); $event.stopImmediatePropagation(); moveCalendarWindow(4)"
                  >
                    <ion-icon
                      name="arrow-forward-outline"
                      slot="icon-only"
                    ></ion-icon>
                  </ion-button>
                </a>
              </div>
            </div>
            @if (!isDateInCalendar(now)) {
              <div style="justify-self: center">
                <ion-button size="small" (click)="changeDate(now)"
                >Heute anzeigen
                </ion-button>
              </div>
            }
          </div>
          <div style="display: flex; column-gap: 8px">
            @if (loadingDay) {
              <ion-spinner name="dots"></ion-spinner>
            }
            @if (!loadingDay) {
              @for (day of placesByDistancePerDay; track day) {
                <div style="flex: 1">
                  <header>
                    <h2 style="font-size: 1.2rem">
                      <time [attr.datetime]="day.date.toDate().toISOString()">
                        {{ getWeekday(day.date) }}, {{ formatDate(day.date, 'DD.MM.YYYY') }}
                      </time>
                      @if (getRelativeDateLabel(day.date)) {
                        <div class="ion-margin-top">
                          <ion-badge
                            [color]="isToday(day.date) ? 'primary': 'light'">{{ getRelativeDateLabel(day.date) }}
                          </ion-badge>
                        </div>
                      }
                    </h2>
                  </header>

                  <div style="display: flex" [ngClass]="{'past-events': isPast(day.date)}">
                    <div>
                      @if (day.eventGroups.length === 0) {
                        <div>
                          <p class="ion-padding-top">
                            <ion-text color="medium">
                              Keine Veranstaltungen gefunden
                            </ion-text>
                          </p>
                        </div>
                      }
                      @for (placesGroup of day.eventGroups; track placesGroup) {
                        <div>
                          @for (place of placesGroup.places; track place) {
                            <h2 class="ion-padding-top">
                              <a
                                [routerLink]="getPlaceUrl(place?.place)"
                                [title]="'Wechsle nach ' + place?.place?.place"
                                style="color: var(--ion-color-dark)"
                                itemprop="url"
                              >
                                <span itemprop="name">{{ place?.place?.place }}</span></a
                              >
                              @if (placesGroup?.distance && placesGroup.distance > 0) {
                                <ion-note> ~ {{ placesGroup.distance }} Km</ion-note>
                              }
                            </h2>
                            <div>
                              @for (event of place.events; track event) {
                                <div class="localized-event">
                                  @if (event.url) {
                                    <a [href]="event.url" target="_blank" rel="noopener" itemprop="url">
                                      <article itemscope itemtype="https://schema.org/Event">
                                        <header>
                                          <h3 itemprop="name">
                                            {{ cleanTitle(event.title) }}

                                          </h3>
                                        </header>
                                      </article>
                                    </a>
                                  } @else {
                                    <article itemscope itemtype="https://schema.org/Event">
                                      <header>
                                        <h3 itemprop="name">
                                          {{ cleanTitle(event.title) }}
                                        </h3>
                                      </header>
                                    </article>
                                  }
                                </div>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }
            }
          </div>
        }
      </div>
    }
  </div>
</ion-content>

<app-upcoming-footer
  [location]="location"
  [perimeter]="perimeter"
></app-upcoming-footer>
