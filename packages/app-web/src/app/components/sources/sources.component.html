<input
  #jsonPicker
  (change)="importFeedlessJson($event)"
  accept="application/json"
  style="display: none"
  type="file"
/>
<ion-toolbar style="--background: transparent">
  <ion-title> Sources </ion-title>
  <ion-buttons slot="end">
    <ion-button
      (click)="fetchCurrentPage('network-only')"
      [disabled]="repository().sources.length === 0"
      class="ion-margin-start"
      shape="round"
      size="small"
      title="Trigger Refresh"
    >
      <ion-icon name="refresh-outline" slot="start"></ion-icon>
      Reload Data
    </ion-button>
    <ion-button (click)="jsonPicker.click()">
      <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
      <ion-label>Import JSON</ion-label>
    </ion-button>
    <ion-button (click)="editOrAddSource()">
      <ion-icon name="add-outline" slot="start"></ion-icon>
      Add Source
      @if (repository().sourcesCount === 0) {
        <app-bubble color="red" slot="end"></app-bubble>
      }
    </ion-button>
  </ion-buttons>
</ion-toolbar>
<!--<ion-toolbar>-->
<!--  <div class="filters">-->
<!--    <ion-select label="Status" fill="outline">-->

<!--    </ion-select>-->
<!--    <ion-select label="Geo Tag" fill="outline">-->

<!--    </ion-select>-->
<!--  </div>-->

<!--</ion-toolbar>-->
<ion-list>
  @if (repository().sourcesCount === 0) {
    <ion-item>
      <ion-label>No sources defined</ion-label>
    </ion-item>
  }

  <ion-row style="opacity: 0.5">
    <ion-col size="1" class="ion-text-center">Status</ion-col>
    <ion-col size="5" class="ion-padding-start">Description</ion-col>
    <ion-col size="2">Refreshed Last</ion-col>
    <ion-col size="2">Retrieved Last</ion-col>
  </ion-row>
  @if (loadingSources) {
    <ion-progress-bar color="medium" type="indeterminate"></ion-progress-bar>
  }

  @for (source of sources; track source.id) {
    <ion-row>
      <ion-col size="1" class="ion-text-center">
        <app-bubble [color]="getHealthColorForSource(source)"></app-bubble>
      </ion-col>
      <ion-col size="5">
        <div style="padding-left: 10px">
          {{ source.title }}
        </div>
        <ion-buttons>
          <ion-button
            (click)="editTags(source)"
            [color]="source.tags?.length > 0 ? 'medium' : 'primary'"
            fill="clear"
            >{{ stringifyTags(source) }}
          </ion-button>
          <ion-button
            (click)="editLatLon(source)"
            [color]="source.latLng ? 'medium' : 'primary'"
            fill="clear"
            >{{ stringifyLocalization(source) }}
          </ion-button>
        </ion-buttons>

        @if (source.disabled) {
          <p>
            <ion-label color="danger">
              Disabled.
              {{ source.lastErrorMessage }}
            </ion-label>
          </p>
        }
      </ion-col>
      <ion-col size="2">
        @if (source.lastRefreshedAt) {
          <ion-text class="nowrap" title="last fetch">
            {{ fromNow(source.lastRefreshedAt) }} ago
          </ion-text>
        } @else {
          <ion-text class="nowrap" title="last fetch" color="">
            Never fetched
          </ion-text>
        }
      </ion-col>
      <ion-col size="2">
        @if (source.lastRefreshedAt) {
          <ion-text
            class="nowrap"
            title="last items retrieved"
            [color]="source.lastRecordsRetrieved === 0 ? 'danger' : undefined"
          >
            {{ source.lastRecordsRetrieved }} items
          </ion-text>
        } @else {
          -
        }
      </ion-col>
      <ion-col size="2">
        <ion-buttons [collapse]="true" style="justify-self: flex-end">
          @if (source.disabled) {
            <ion-button
              (click)="setDisabledForSource(source, false)"
              color="success"
              fill="solid"
            >
              Enable
            </ion-button>
          }
          <ion-button (click)="editOrAddSource(source)"> Edit </ion-button>
          <ion-button (click)="showSourceOptions(source)">
            <ion-icon
              name="ellipsis-vertical-outline"
              slot="icon-only"
            ></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-col>
    </ion-row>
  }

  <app-pagination
    (pageChange)="fetchSources($event)"
    [currentPage]="currentSourcesPage"
    [isLastPage]="sources.length === 0"
  ></app-pagination>
</ion-list>
