# Date-based redirect configuration for events URLs
# This configuration handles URLs with the pattern: /events/in/.../am/YYYY/M/DD/...

server {
  root /usr/share/nginx/html;
  index index.html;
  etag on;

  access_log /dev/stdout;
  error_log /dev/stderr warn;

  location = /favicon.ico { access_log off; log_not_found off; }
  location = /robots.txt { access_log off; log_not_found off; }
  location = /sitemap.xml { access_log off; log_not_found off; }

  error_page 404 =200 /;

  # Handle date-based redirects for events URLs
  # Redirect URLs with dates older than 1 week to today's date
  location ~ ^/events/in/.*/am/([0-9]+)/([0-9]+)/([0-9]+)/ {
    # Store the captured date components
    set $url_year $1;
    set $url_month $2;
    set $url_day $3;

    # Use Lua to check if date is older than 1 week and redirect
    access_by_lua_block {
      local year = tonumber(ngx.var.url_year)
      local month = tonumber(ngx.var.url_month)
      local day = tonumber(ngx.var.url_day)

      if year and month and day then
        local url_date = os.time({year=year, month=month, day=day})
        local current_time = os.time()
        local week_in_seconds = 7 * 24 * 60 * 60

        if url_date < (current_time - week_in_seconds) then
          local today = os.date("*t", current_time)
          local new_uri = string.gsub(ngx.var.uri, "/([0-9]+)/([0-9]+)/([0-9]+)/",
            "/" .. today.year .. "/" .. today.month .. "/" .. today.day .. "/")
          ngx.redirect(new_uri, 302)
          return
        end
      end
    }

    try_files $uri $uri/ =404;
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate";
    expires 0;
  }

  # Cache static files
  location ~* \.(?:css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf)$ {
      expires 7d;
      access_log off;
      add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # Do not cache index
  location / {
      try_files $uri $uri/ =404;
      add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate";
      expires 0;
  }

  gzip on;
  gzip_static on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_buffers 16 8k;
  gzip_http_version 1.1;
  gzip_min_length 256;
  gzip_types
    application/atom+xml
    application/geo+json
    application/javascript
    application/x-javascript
    application/json
    application/ld+json
    application/manifest+json
    application/rdf+xml
    application/rss+xml
    application/xhtml+xml
    application/xml
    font/eot
    font/otf
    font/ttf
    image/svg+xml
    text/css
    text/javascript
    text/plain
    text/xml;
  gzip_disable "MSIE [1-6]\.";
}
